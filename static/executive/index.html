<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Vista Ejecutiva</title>
  <link rel="stylesheet" href="/static/styles.css" />
  <style>
    .kpi-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 16px; margin-bottom: 20px; }
    .kpi-card { background:#1e1e1e; border-radius: 14px; padding: 18px; box-shadow: 0 4px 10px rgba(0,0,0,0.6); text-align: center; }
    .kpi-card h3 { color:#ff9800; font-size: 18px; margin-bottom: 8px; }
    .kpi-card p { font-size: 28px; font-weight: 800; }
  </style>
</head>
<body>
  <div class="dashboard">
    <main class="main">
      <header class="header">
        <div class="brand">
          <img src="/static/logo.png" class="brand-logo" alt="Logo" />
          <h1>Vista Ejecutiva</h1>
        </div>
        <div class="filters">
          <select id="stationExec">
            <option value="all" selected>Todas</option>
            <option value="Portobelo">Portobelo</option>
            <option value="Salvio">Salvio</option>
          </select>
          <select id="monthExec">
            <option value="">Mes actual</option>
          </select>
          <a href="/" class="btn-action">← Volver</a>
          <div class="userbox">
            <button id="userBtn" class="avatar-btn" aria-haspopup="menu" aria-expanded="false" title="Cuenta">
              <svg width="26" height="26" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                <circle cx="12" cy="8" r="4" stroke="#ff9800" stroke-width="2"/>
                <path d="M4 20c0-4 4-6 8-6s8 2 8 6" stroke="#ff9800" stroke-width="2" stroke-linecap="round"/>
              </svg>
            </button>
            <div id="userMenu" class="user-menu hidden" role="menu" aria-label="Cuenta">
              <div class="user-info">
                <div id="userFullName" class="user-name">-</div>
                <div id="userEmail" class="user-email">-</div>
              </div>
              <button id="logoutBtn" class="nav-btn" type="button" role="menuitem">Salir</button>
            </div>
          </div>
        </div>
      </header>

      <section class="kpi-cards">
        <div class="kpi-card"><h3>Clientes activos</h3><p id="kpiActive">0</p></div>
        <div class="kpi-card"><h3>Crecimiento mensual</h3><p id="kpiGrowth">0%</p></div>
        <div class="kpi-card"><h3>Ingresos del mes</h3><p id="kpiRevenueMonth">$0</p></div>
        <div class="kpi-card"><h3>Ingresos YTD</h3><p id="kpiRevenueYtd">$0</p></div>
        <div class="kpi-card"><h3>Ingresos totales</h3><p id="kpiRevenueTotal">$0</p></div>
        <div class="kpi-card"><h3>Utilización promedio</h3><p id="kpiUtil">0%</p></div>
      </section>

      <section class="charts">
        <div class="charts-grid">
          <div class="chart-card">
            <h3>Cargas: Mes actual vs Anterior</h3>
            <canvas id="execCharges"></canvas>
          </div>
          <div class="chart-card">
            <h3>Ingresos YTD vs Meta</h3>
            <canvas id="execRevenue"></canvas>
          </div>
          <div class="chart-card">
            <h3>Utilización promedio</h3>
            <canvas id="execUtil"></canvas>
          </div>
        </div>
      </section>
    </main>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const station = document.getElementById('stationExec');
      const month = document.getElementById('monthExec');
      // Rellenar selector con últimos 12 meses
      const now = new Date();
      for(let i=0;i<12;i++){
        const d = new Date(now.getFullYear(), now.getMonth()-i, 1);
        const yyyy = d.getFullYear();
        const mm = String(d.getMonth()+1).padStart(2,'0');
        const opt = document.createElement('option');
        opt.value = `${yyyy}-${mm}`;
        opt.textContent = `${yyyy}-${mm}`;
        month.appendChild(opt);
      }

      const load = async () => {
        const url = new URL('/api/stats/executive/summary', window.location.origin);
        if(month.value) url.searchParams.set('month', month.value);
        url.searchParams.set('station', station.value);
        url.searchParams.set('materialized', 'true');
        const res = await fetch(url);
        const data = await res.json();
        const fmtCOP = new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', maximumFractionDigits: 0 });
        document.getElementById('kpiActive').textContent = data.active_customers ?? 0;
        document.getElementById('kpiGrowth').textContent = (data.growth_pct ?? 0).toFixed(1) + '%';
        document.getElementById('kpiRevenueMonth').textContent = fmtCOP.format(data.revenue_month ?? 0);
        document.getElementById('kpiRevenueYtd').textContent = fmtCOP.format(data.revenue_ytd ?? 0);
        document.getElementById('kpiRevenueTotal').textContent = fmtCOP.format(data.revenue_total ?? 0);
        document.getElementById('kpiUtil').textContent = (data.utilization_pct ?? 0).toFixed(1) + '%';

        drawExecCharts(data);
      };

      station.addEventListener('change', load);
      month.addEventListener('change', load);
      load();
      function setupCanvas(canvas, cssW, cssH, dpr) {
        canvas.style.width = cssW + 'px';
        canvas.style.height = cssH + 'px';
        canvas.width = Math.floor(cssW * dpr);
        canvas.height = Math.floor(cssH * dpr);
        const ctx = canvas.getContext('2d');
        ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
        return ctx;
      }

      function drawBars(ctx, labels, data, colors){
        const W = parseInt(ctx.canvas.style.width)||900; const H = parseInt(ctx.canvas.style.height)||300;
        ctx.clearRect(0,0,W,H);
        const left=56,right=16,top=24,bottom=44; const chartW=W-left-right, chartH=H-top-bottom;
        const maxVal=Math.max(1,...data); const steps=5; const stepVal=Math.ceil(maxVal/steps);
        const maxAxis=stepVal*steps; ctx.strokeStyle='#333'; ctx.lineWidth=1; ctx.font='12px sans-serif'; ctx.fillStyle='#aaa'; ctx.textAlign='right';
        for(let i=0;i<=steps;i++){ const y=top+chartH-(i/steps)*chartH; ctx.beginPath(); ctx.moveTo(left,y); ctx.lineTo(W-right,y); ctx.stroke(); ctx.fillText(String(Math.round((i*maxAxis)/steps)), left-8, y+4); }
        const groupW=chartW/labels.length; const barW=Math.min(100, groupW*0.5); ctx.textAlign='center';
        labels.forEach((lab,i)=>{ const xC=left+i*groupW+groupW/2; const v=data[i]; const h=(v/maxAxis)*chartH; const x=xC-barW/2; const y=top+chartH-h; ctx.fillStyle=colors[i%colors.length]; ctx.fillRect(x,y,barW,h); ctx.fillStyle='#ccc'; ctx.fillText(lab,xC,H-16); ctx.fillText(String(v), xC, Math.max(top+12, y-6)); });
      }

      function drawDonut(ctx, value, total){
        const W=parseInt(ctx.canvas.style.width)||360; const H=parseInt(ctx.canvas.style.height)||300; ctx.clearRect(0,0,W,H);
        const cx=W/2, cy=H/2, r=Math.min(W,H)/3; const pct= total>0? Math.min(1,value/total):0;
        // base
        ctx.beginPath(); ctx.arc(cx,cy,r,0,Math.PI*2); ctx.strokeStyle='#333'; ctx.lineWidth=22; ctx.stroke();
        // value
        ctx.beginPath(); ctx.arc(cx,cy,r,-Math.PI/2,-Math.PI/2+Math.PI*2*pct); ctx.strokeStyle='#ff9800'; ctx.lineWidth=22; ctx.stroke();
        ctx.font='18px sans-serif'; ctx.fillStyle='#ddd'; ctx.textAlign='center'; ctx.fillText(`${Math.round(pct*100)}%`, cx, cy+6);
      }

      function drawExecCharts(data){
        const dpr = Math.max(1, window.devicePixelRatio||1);
        // Charges bars
        const bars = document.getElementById('execCharges');
        if(bars){ const w = Math.min(800, bars.parentElement.clientWidth-32); const h=320; const ctx=setupCanvas(bars,w,h,dpr); drawBars(ctx, ['Actual','Anterior'], [data.charges_month||0, data.charges_prev_month||0], ['#03A9F4','#8BC34A']); }
        // Revenue donut
        const rev = document.getElementById('execRevenue');
        if(rev){ const w = Math.min(600, rev.parentElement.clientWidth-32); const h=320; const ctx=setupCanvas(rev,w,h,dpr); drawDonut(ctx, data.revenue_ytd||0, data.revenue_target_ytd||0); }
        // Utilization bar (single)
        const util = document.getElementById('execUtil');
        if(util){ const w = Math.min(600, util.parentElement.clientWidth-32); const h=220; const ctx=setupCanvas(util,w,h,dpr); drawBars(ctx, ['Utilización %'], [Math.round((data.utilization_pct||0))], ['#ff9800']); }
      }

    });
  </script>
  <script src="/static/scripts.js"></script>
</body>
</html>
